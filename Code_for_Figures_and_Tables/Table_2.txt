# Load vegan
library(vegan)

# Paths
otu_path <- "/Users/cbivins/Desktop/Oak_Endophyte_Project_NEATEST/Abundance_CSV_Files/Relative_Abundance/RA_otu_table.csv"
metadata_path <- "/Users/cbivins/Desktop/Oak_Endophyte_Project_NEATEST/Abundance_CSV_Files/Relative_Abundance/metadata.csv"
output_path <- "/Users/cbivins/Desktop/Oak_Endophyte_Project_NEATEST/Beta_Diversity_Analysis/Bray-Curtis/Stats/Nested_PERMANOVA_w_strata/permanova_results.csv"

# Load data
otu <- read.csv(otu_path, row.names = 1, check.names = FALSE)
meta <- read.csv(metadata_path, check.names = FALSE)
otu_t <- t(otu)
meta <- meta[match(rownames(otu_t), meta$Sample_ID), ]

# Run PERMANOVA with 'by = "terms"' to decompose effects
permanova <- adonis2(
  otu_t ~ Species * Site * Month,
  data = meta,
  permutations = 999,
  method = "bray",
  strata = meta$TreeID,
  by = "terms"
)

# Export as CSV 
write.csv(permanova, output_path)